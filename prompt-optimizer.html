<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prompt Optimization Studio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 50%, #e0e7ff 100%);
    }

    .card {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="gradient-bg min-h-screen p-6">
  <!-- API Key Modal -->
  <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-800">Gemini API Key</h2>
      </div>

      <p class="text-gray-600 mb-4">
        Um zu starten, benötigst du einen kostenlosen Gemini 2.5 Flash API-Schlüssel.
      </p>

      <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener"
         class="block text-blue-600 hover:text-blue-700 mb-4 text-sm font-medium">
        → API-Schlüssel bei Google AI Studio erstellen
      </a>

      <input type="password" id="apiKeyInput" placeholder="Gemini API Key eingeben..."
             class="w-full p-4 border-2 border-gray-200 rounded-2xl focus:border-blue-400 focus:outline-none mb-4">

      <div class="flex gap-3">
        <button onclick="saveApiKey()"
                class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-semibold py-3 px-6 rounded-2xl hover:shadow-lg transition-all">
          Speichern & Starten
        </button>
        <button onclick="closeApiKeyModal()" id="cancelButton"
                class="px-6 py-3 border-2 border-gray-200 text-gray-600 font-semibold rounded-2xl hover:bg-gray-50 transition-all hidden">
          Abbrechen
        </button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="max-w-7xl mx-auto hidden">
    <!-- Header -->
    <div class="text-center mb-12">
      <div class="inline-flex items-center gap-3 mb-4">
        <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl flex items-center justify-center shadow-lg">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
          </svg>
        </div>
        <h1 class="text-4xl font-bold bg-gradient-to-r from-gray-800 to-blue-800 bg-clip-text text-transparent">
          Prompt Optimization Studio
        </h1>
      </div>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto leading-relaxed">
        Transformiere deine Text-Classification-Prompts mit KI-gestützter Optimierung
      </p>
      <button onclick="showApiKeyModal()" class="mt-4 text-sm text-blue-600 hover:text-blue-700 font-medium">
        API-Schlüssel ändern
      </button>
    </div>

    <div class="grid xl:grid-cols-2 gap-8">
      <!-- Input Section -->
      <div class="space-y-6">
        <!-- Original Prompt -->
        <div class="card rounded-3xl p-8 shadow-xl">
          <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
              <span class="text-blue-600 font-bold text-sm">1</span>
            </div>
            Original Prompt
          </h2>

          <textarea id="originalPrompt" placeholder="Gib deinen Text-Classification-Prompt hier ein..."
                    class="w-full h-48 p-4 rounded-2xl border border-gray-200 focus:border-blue-400 focus:ring-4 focus:ring-blue-100 transition-all duration-300 resize-none bg-white bg-opacity-80 text-gray-700 placeholder-gray-400"
          ></textarea>
        </div>

        <!-- Optimization Type -->
        <div class="card rounded-3xl p-8 shadow-xl">
          <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
              <span class="text-blue-600 font-bold text-sm">2</span>
            </div>
            Optimierungstyp
          </h2>

          <div class="space-y-3" id="optimizationTypes">
            <label class="flex items-start gap-4 p-4 rounded-2xl border border-gray-200 cursor-pointer hover:border-blue-300 hover:bg-blue-25 transition-all">
              <input type="radio" name="criticType" value="consistency" checked class="mt-1 text-blue-600">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <span class="font-semibold text-gray-800">Internal Consistency Check</span>
                </div>
                <p class="text-sm text-gray-600">Logischen Fluss überprüfen und Widersprüche eliminieren</p>
              </div>
            </label>

            <label class="flex items-start gap-4 p-4 rounded-2xl border border-gray-200 cursor-pointer hover:border-blue-300 hover:bg-blue-25 transition-all">
              <input type="radio" name="criticType" value="feedback" class="mt-1 text-blue-600">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                  </svg>
                  <span class="font-semibold text-gray-800">Feedback-Based Revision</span>
                </div>
                <p class="text-sm text-gray-600">Prompt basierend auf spezifischem Feedback verbessern</p>
              </div>
            </label>

            <label class="flex items-start gap-4 p-4 rounded-2xl border border-gray-200 cursor-pointer hover:border-blue-300 hover:bg-blue-25 transition-all">
              <input type="radio" name="criticType" value="clarity" class="mt-1 text-blue-600">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                  </svg>
                  <span class="font-semibold text-gray-800">Clarity Enhancement</span>
                </div>
                <p class="text-sm text-gray-600">Lesbarkeit verbessern und Mehrdeutigkeit entfernen</p>
              </div>
            </label>

            <label class="flex items-start gap-4 p-4 rounded-2xl border border-gray-200 cursor-pointer hover:border-blue-300 hover:bg-blue-25 transition-all">
              <input type="radio" name="criticType" value="effectiveness" class="mt-1 text-blue-600">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                  </svg>
                  <span class="font-semibold text-gray-800">Effectiveness Optimization</span>
                </div>
                <p class="text-sm text-gray-600">Klassifikationsgenauigkeit und Performance maximieren</p>
              </div>
            </label>
          </div>

          <div id="feedbackSection" class="mt-6 hidden">
            <button onclick="toggleFeedbackInput()" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium mb-3 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
              <span id="feedbackToggleText">Feedback-Details hinzufügen</span>
            </button>

            <textarea id="feedbackText" placeholder="Beschreibe das spezifische Feedback oder die Probleme, die adressiert werden sollen..."
                      class="w-full h-32 p-4 rounded-2xl border border-gray-200 focus:border-blue-400 focus:ring-4 focus:ring-blue-100 transition-all duration-300 resize-none bg-white bg-opacity-80 text-gray-700 placeholder-gray-400 hidden"
            ></textarea>
          </div>
        </div>

        <!-- Optimize Button -->
        <button id="optimizeButton" onclick="optimizePrompt()"
                class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-semibold py-4 px-8 rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
          </svg>
          <span id="optimizeButtonText">Prompt optimieren</span>
        </button>
      </div>

      <!-- Output Section -->
      <div class="space-y-6">
        <!-- Optimized Prompt -->
        <div class="card rounded-3xl p-8 shadow-xl">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 flex items-center gap-3">
              <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                <span class="text-green-600 font-bold text-sm">3</span>
              </div>
              Optimierter Prompt
            </h2>

            <button id="copyButton" onclick="copyToClipboard()"
                    class="hidden items-center gap-2 px-4 py-2 rounded-xl font-medium transition-all duration-300 bg-gray-100 text-gray-700 hover:bg-gray-200 border border-gray-200">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
              </svg>
              <span id="copyButtonText">Kopieren</span>
            </button>
          </div>

          <div id="optimizedPromptContainer"
               class="w-full h-80 p-4 rounded-2xl border border-gray-200 bg-white bg-opacity-80 overflow-y-auto">
            <div class="flex items-center justify-center h-full text-gray-400">
              <div class="text-center">
                <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                </svg>
                <p class="text-lg">Dein optimierter Prompt erscheint hier</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Change Analysis -->
        <div class="card rounded-3xl p-8 shadow-xl">
          <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center gap-3">
            <div class="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center">
              <span class="text-amber-600 font-bold text-sm">4</span>
            </div>
            Änderungsanalyse
          </h2>

          <div id="changeSummaryContainer"
               class="w-full h-64 p-4 rounded-2xl border border-gray-200 bg-white bg-opacity-80 overflow-y-auto">
            <div class="flex items-center justify-center h-full text-gray-400">
              <div class="text-center">
                <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p class="text-lg">Änderungsanalyse erscheint hier</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-center mt-12 text-gray-500">
      <p>Powered by Google Gemini 2.5 Flash • Kostenlose API</p>
    </div>
  </div>

  <script>
    let apiKey = localStorage.getItem('gemini_api_key');
    let showFeedbackInput = false;

    // Initialize app
    function init() {
      if (apiKey) {
        document.getElementById('apiKeyModal').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('cancelButton').classList.remove('hidden');
      } else {
        document.getElementById('apiKeyModal').classList.remove('hidden');
      }

      // Add event listeners for optimization type
      document.querySelectorAll('input[name="criticType"]').forEach(radio => {
        radio.addEventListener('change', handleCriticTypeChange);
      });
    }

    function handleCriticTypeChange(e) {
      const feedbackSection = document.getElementById('feedbackSection');
      if (e.target.value === 'feedback') {
        feedbackSection.classList.remove('hidden');
      } else {
        feedbackSection.classList.add('hidden');
        document.getElementById('feedbackText').classList.add('hidden');
        showFeedbackInput = false;
        document.getElementById('feedbackToggleText').textContent = 'Feedback-Details hinzufügen';
      }

      // Update selected state
      document.querySelectorAll('input[name="criticType"]').forEach(radio => {
        const label = radio.closest('label');
        if (radio.checked) {
          label.classList.add('border-blue-400', 'bg-blue-50', 'shadow-lg');
          label.classList.remove('border-gray-200');
        } else {
          label.classList.remove('border-blue-400', 'bg-blue-50', 'shadow-lg');
          label.classList.add('border-gray-200');
        }
      });
    }

    function toggleFeedbackInput() {
      showFeedbackInput = !showFeedbackInput;
      const feedbackText = document.getElementById('feedbackText');
      const toggleText = document.getElementById('feedbackToggleText');

      if (showFeedbackInput) {
        feedbackText.classList.remove('hidden');
        toggleText.textContent = 'Feedback-Details verbergen';
      } else {
        feedbackText.classList.add('hidden');
        toggleText.textContent = 'Feedback-Details hinzufügen';
      }
    }

    function showApiKeyModal() {
      document.getElementById('apiKeyModal').classList.remove('hidden');
    }

    function closeApiKeyModal() {
      if (apiKey) {
        document.getElementById('apiKeyModal').classList.add('hidden');
      }
    }

    function saveApiKey() {
      const input = document.getElementById('apiKeyInput');
      const key = input.value.trim();

      if (!key) {
        alert('Bitte gib einen API-Schlüssel ein');
        return;
      }

      apiKey = key;
      localStorage.setItem('gemini_api_key', key);
      document.getElementById('apiKeyModal').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('cancelButton').classList.remove('hidden');
      input.value = '';
    }

    function buildOptimizationPrompt(criticType, originalPrompt, feedbackText) {
      const baseInstruction = `You are an expert prompt engineer specializing in text classification tasks. Your goal is to improve the following prompt while preserving its EXACT original structure, formatting, line breaks, indentation, and layout.

Original Prompt:
"""
${originalPrompt}
"""

`;

      let specificInstructions = '';

      switch(criticType) {
        case 'consistency':
          specificInstructions = `OPTIMIZATION TYPE: INTERNAL CONSISTENCY CHECK

Your task is to identify and fix logical contradictions, inconsistencies, and conflicting instructions within the prompt.

Specific focus areas:
1. CONTRADICTORY INSTRUCTIONS: Find places where the prompt gives conflicting guidance (e.g., "be brief" vs "provide detailed examples")
2. INCONSISTENT TERMINOLOGY: Identify where the same concept is referred to with different terms and standardize it
3. LOGICAL FLOW: Ensure steps or instructions follow a logical sequence
4. SCOPE CONFLICTS: Fix areas where the scope of the task is defined differently in different sections
5. CONFLICTING EXAMPLES: Ensure all examples align with each other and with the main instructions
6. REDUNDANCIES: Remove duplicate or repetitive instructions that might confuse the model
7. INCOMPATIBLE REQUIREMENTS: Identify requirements that cannot all be satisfied simultaneously

Changes to make:
- Standardize terminology throughout
- Remove or reconcile contradictory statements
- Ensure all parts of the prompt support the same goal
- Make the logical structure clear and consistent
- Align all examples with the core instructions`;
          break;

        case 'feedback':
          specificInstructions = `OPTIMIZATION TYPE: FEEDBACK-BASED REVISION

Your task is to address specific feedback and issues while improving the prompt's effectiveness.

${feedbackText ? `SPECIFIC FEEDBACK TO ADDRESS:\n"""${feedbackText}"""\n` : ''}

Specific focus areas:
1. ADDRESS ALL FEEDBACK POINTS: Make sure every concern mentioned in the feedback is resolved
2. ROOT CAUSE FIXES: Don't just patch symptoms - fix underlying issues
3. MAINTAIN EFFECTIVENESS: While addressing feedback, ensure you don't break what's working
4. PROACTIVE IMPROVEMENTS: If feedback hints at deeper issues, fix those too
5. CLEAR INSTRUCTIONS: Make sure the revised areas are clearer than before
6. EXAMPLES & CLARIFICATION: Add examples if feedback indicates confusion
7. VALIDATION: Ensure your changes actually solve the reported problems

Changes to make:
- Directly address each feedback point
- Fix any underlying structural issues revealed by feedback
- Add clarifying examples if confusion was mentioned
- Strengthen weak areas identified in feedback
- Ensure the prompt now handles the problematic cases better`;
          break;

        case 'clarity':
          specificInstructions = `OPTIMIZATION TYPE: CLARITY ENHANCEMENT

Your task is to make the prompt significantly clearer, more readable, and less ambiguous without changing its intent.

Specific focus areas:
1. AMBIGUOUS PHRASING: Replace vague or ambiguous language with precise, unambiguous instructions
2. COMPLEX SENTENCES: Break down complex, multi-clause sentences into simpler ones
3. JARGON & TERMINOLOGY: Clarify or define technical terms, or replace with simpler alternatives
4. UNCLEAR REFERENCES: Fix pronouns and references that could be misinterpreted (this, that, it, etc.)
5. IMPLICIT INSTRUCTIONS: Make implicit expectations explicit and clear
6. CONFUSING STRUCTURE: Reorganize if the flow is hard to follow (but keep same overall structure)
7. MISSING CONTEXT: Add clarifying context where assumptions might be unclear
8. STRONGER VERBS: Use specific action verbs instead of weak ones (e.g., "analyze" not "look at")

Changes to make:
- Replace ambiguous words with specific ones
- Simplify sentence structure without losing meaning
- Make all instructions explicit rather than implied
- Clarify what each part of the prompt requires
- Use concrete examples to illustrate abstract concepts
- Ensure pronouns have clear antecedents
- Define or clarify any specialized terms`;
          break;

        case 'effectiveness':
          specificInstructions = `OPTIMIZATION TYPE: EFFECTIVENESS OPTIMIZATION

Your task is to maximize the prompt's ability to produce accurate, high-quality text classification results.

Specific focus areas:
1. CLASSIFICATION CRITERIA: Make classification criteria more precise, measurable, and actionable
2. EDGE CASES: Add guidance for handling ambiguous or boundary cases
3. DECISION FRAMEWORK: Strengthen the decision-making framework with clear prioritization rules
4. DISCRIMINATIVE FEATURES: Emphasize the most important distinguishing features between categories
5. ERROR PREVENTION: Add safeguards against common classification mistakes
6. OUTPUT FORMAT: Ensure output format requirements are crystal clear and unambiguous
7. CONFIDENCE HANDLING: Add guidance for expressing uncertainty when appropriate
8. EXAMPLES: Ensure examples cover diverse cases and demonstrate key distinctions
9. CONSTRAINTS: Make any constraints or requirements more explicit and enforceable

Changes to make:
- Sharpen classification criteria with specific, observable indicators
- Add decision rules for ambiguous cases
- Emphasize discriminative features that separate categories
- Include both positive and negative examples for each category
- Add explicit instructions for handling edge cases
- Strengthen output format requirements
- Add quality checks or verification steps
- Make success criteria measurable and concrete`;
          break;
      }

      const jsonInstructions = `

Please provide your response in the following JSON format. Be very careful with JSON escaping - use \\n for line breaks and escape quotes properly:

{
  "optimized_prompt": "The improved version of the prompt with exact formatting preserved",
  "change_summary": "A detailed summary of what was changed and why"
}

CRITICAL REQUIREMENTS:
1. PRESERVE STRUCTURE: Keep the exact same structure, formatting, line breaks, indentation, bullet points, and numbering
2. PRESERVE EXAMPLES: Keep all existing examples intact (you can improve them, but don't remove them)
3. FOCUSED CHANGES: Only make changes relevant to the optimization type above
4. STAY ON TARGET: Don't mix optimization types - focus ONLY on the specific type requested
5. DOCUMENT CHANGES: In change_summary, explain exactly what you changed and why it improves the prompt

IMPORTANT:
- Your response must be ONLY a valid JSON object
- Properly escape all quotes (use \\" for quotes inside strings)
- Properly escape newlines (use \\n for line breaks)
- Do NOT include markdown code blocks or any text outside the JSON
- The optimized_prompt field must have the same formatting structure as the original`;

      return baseInstruction + specificInstructions + jsonInstructions;
    }

    async function optimizePrompt() {
      const originalPrompt = document.getElementById('originalPrompt').value.trim();

      if (!originalPrompt) {
        alert('Bitte gib einen Prompt ein');
        return;
      }

      const criticType = document.querySelector('input[name="criticType"]:checked').value;
      const feedbackText = document.getElementById('feedbackText').value.trim();

      // Build specialized prompt for each optimization type
      const prompt = buildOptimizationPrompt(criticType, originalPrompt, feedbackText);

      // Show loading state
      const button = document.getElementById('optimizeButton');
      const buttonText = document.getElementById('optimizeButtonText');
      button.disabled = true;
      buttonText.textContent = 'Optimiere...';
      button.innerHTML = '<div class="spinner"></div><span>Optimiere...</span>';

      try {
        const response = await callGeminiAPI(prompt);

        // Parse response
        let cleanedResponse = response.trim();

        // Remove markdown code blocks if present
        if (cleanedResponse.startsWith('```json')) {
          cleanedResponse = cleanedResponse.replace(/^```json\s*/, '').replace(/```\s*$/, '');
        } else if (cleanedResponse.startsWith('```')) {
          cleanedResponse = cleanedResponse.replace(/^```\s*/, '').replace(/```\s*$/, '');
        }

        const parsedResponse = JSON.parse(cleanedResponse);

        if (parsedResponse.optimized_prompt && parsedResponse.change_summary) {
          displayResults(parsedResponse.optimized_prompt, parsedResponse.change_summary);
        } else {
          throw new Error('Missing required fields in response');
        }
      } catch (error) {
        console.error('Error:', error);

        if (error.message && error.message.includes('API_KEY_INVALID')) {
          alert('Ungültiger API-Schlüssel. Bitte überprüfe deinen Gemini API-Schlüssel.');
          showApiKeyModal();
        } else {
          alert('Fehler bei der Optimierung. Bitte versuche es erneut.');
        }

        document.getElementById('optimizedPromptContainer').innerHTML = `
          <div class="text-red-600 p-4">
            <p class="font-semibold mb-2">Fehler bei der Optimierung</p>
            <p class="text-sm">${error.message || 'Bitte versuche es erneut.'}</p>
          </div>
        `;
      } finally {
        // Reset button state
        button.disabled = false;
        button.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
          </svg>
          <span>Prompt optimieren</span>
        `;
      }
    }

    async function callGeminiAPI(prompt) {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`;

      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          contents: [{
            parts: [{
              text: prompt
            }]
          }],
          generationConfig: {
            temperature: 0.7,
            topK: 40,
            topP: 0.95,
            maxOutputTokens: 8192,
          }
        })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error?.message || 'API request failed');
      }

      const data = await response.json();

      if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
        throw new Error('Invalid response from API');
      }

      return data.candidates[0].content.parts[0].text;
    }

    function displayResults(optimizedPrompt, changeSummary) {
      // Display optimized prompt
      document.getElementById('optimizedPromptContainer').innerHTML = `
        <div class="prose prose-slate max-w-none fade-in">
          <pre class="whitespace-pre-wrap text-gray-700 font-mono text-sm leading-relaxed">${escapeHtml(optimizedPrompt)}</pre>
        </div>
      `;

      document.getElementById('optimizedPromptContainer').classList.remove('border-gray-200');
      document.getElementById('optimizedPromptContainer').classList.add('border-green-200', 'bg-green-50', 'bg-opacity-50');

      // Display change summary
      document.getElementById('changeSummaryContainer').innerHTML = `
        <div class="prose prose-slate max-w-none fade-in">
          <div class="text-gray-700 text-sm leading-relaxed whitespace-pre-wrap">${escapeHtml(changeSummary)}</div>
        </div>
      `;

      document.getElementById('changeSummaryContainer').classList.remove('border-gray-200');
      document.getElementById('changeSummaryContainer').classList.add('border-amber-200', 'bg-amber-50', 'bg-opacity-50');

      // Show copy button
      document.getElementById('copyButton').classList.remove('hidden');
      document.getElementById('copyButton').classList.add('flex');

      // Store for copying
      window.currentOptimizedPrompt = optimizedPrompt;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function copyToClipboard() {
      if (!window.currentOptimizedPrompt) return;

      try {
        await navigator.clipboard.writeText(window.currentOptimizedPrompt);

        const button = document.getElementById('copyButton');
        const buttonText = document.getElementById('copyButtonText');

        button.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
        button.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
        buttonText.textContent = 'Kopiert!';

        setTimeout(() => {
          button.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
          button.classList.remove('bg-green-100', 'text-green-700', 'border-green-200');
          buttonText.textContent = 'Kopieren';
        }, 2000);
      } catch (error) {
        console.error('Failed to copy:', error);
        alert('Kopieren fehlgeschlagen');
      }
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
